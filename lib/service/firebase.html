<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Food Data</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

    <div class="container mt-5">
        <div class="card shadow p-4">
            <h2 class="text-center text-primary">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Firebase Firestore</h2>
            <form id="foodForm" class="mt-4">
                <div class="mb-3">
                    <label for="name" class="form-label">‡∏ä‡∏∑‡πà‡∏≠</label>
                    <input type="text" id="name" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label for="category" class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                    <input type="text" id="category" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label for="ingredients" class="form-label">‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏° (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ,)</label>
                    <input type="text" id="ingredients" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label for="image" class="form-label">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</label>
                    <input type="file" id="image" class="form-control" accept="image/*">
                </div>

                <button type="button" class="btn btn-primary w-100" onclick="uploadData()">üì§ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </form>

            <hr>

            <h4 class="mt-4 text-center">üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Excel</h4>
            <input type="file" id="excelFile" class="form-control mt-2" accept=".xlsx">
            <button class="btn btn-success w-100 mt-2" onclick="importExcel()">üìÇ Import Excel</button>

            <p id="status" class="text-center mt-3 fw-bold"></p>
        </div>

        <hr>

        <h3 class="text-center mt-4">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h3>
        <table class="table table-striped mt-3">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                    <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                    <th>‡∏£‡∏π‡∏õ</th>
                    <th>‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°</th>
                    <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
            </thead>
            <tbody id="foodTable"></tbody>
        </table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Firebase & XLSX -->
    <script type="module">
        import { db, storage } from "./firebase.js";
        import { getDocs, addDoc, doc, deleteDoc, updateDoc, collection } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";
        import * as XLSX from "https://cdn.sheetjs.com/xlsx-latest/package/xlsx.mjs";

        document.addEventListener("DOMContentLoaded", loadData);

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        async function uploadData() {
            const name = document.getElementById("name").value.trim();
            const category = document.getElementById("category").value.trim();
            const imageFile = document.getElementById("image").files[0];
            const ingredients = document.getElementById("ingredients").value.trim().split(",").map(item => item.trim());

            if (!name || !category || !imageFile || ingredients.length === 0) {
                document.getElementById("status").innerText = "‚ö†Ô∏è ‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô!";
                return;
            }

            const imageRef = ref(storage, `Products/${Date.now()}_${imageFile.name}`);
            await uploadBytes(imageRef, imageFile);
            const imageUrl = await getDownloadURL(imageRef);

            await addDoc(collection(db, "FoodMenu"), { name, category, imageUrl, ingredients, rating: "0" });

            document.getElementById("status").innerText = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!";
            document.getElementById("foodForm").reset();
            loadData();
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firestore
        async function loadData() {
            const querySnapshot = await getDocs(collection(db, "FoodMenu"));
            const table = document.getElementById("foodTable");
            table.innerHTML = "";

            let index = 1;
            querySnapshot.forEach(doc => {
                const data = doc.data();
                const ingredients = data.ingredients ? data.ingredients.join(", ") : "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";

                table.innerHTML += `
            <tr>
                <td>${index}</td>
                <td>${data.name}</td>
                <td>${data.category}</td>
                <td><img src="${data.imageUrl ? data.imageUrl : 'https://placehold.co/400x300'}" width="50"></td>
                <td>${ingredients}</td> 
                <td>
                    <button class="btn btn-warning btn-sm" onclick="editFood('${doc.id}', '${encodeURIComponent(data.name)}', '${encodeURIComponent(data.category)}', '${encodeURIComponent(data.imageUrl)}')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteFood('${doc.id}')">üóë ‡∏•‡∏ö</button>
                </td>
            </tr>`;
                index++;
            });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        async function deleteFood(id) {
            await deleteDoc(doc(db, "FoodMenu", id));
            Swal.fire('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '', 'success');
            loadData();
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        window.editFood = async function (id, name, category, imageUrl, event = null) {
            if (event && typeof event.preventDefault === "function") {
                event.preventDefault(); // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤
            }

            // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å `encodeURIComponent` ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥
            name = decodeURIComponent(name);
            category = decodeURIComponent(category);
            imageUrl = decodeURIComponent(imageUrl);

            console.log("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°:", { name, category, imageUrl });

            const { value: formValues } = await Swal.fire({
                title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                html: `
                    <input id="name" class="swal2-input form-control" value="${name}">
                    <input id="category" class="swal2-input form-control" value="${category}">
                    <input id="imageUrl" class="swal2-input form-control" value="${imageUrl}">
                    <input type="file" id="imageUpload" class="swal2-file form-control" accept="image/*">
                    <div class="mt-3">
                        <img id="previewImage" src="${imageUrl}" class="img-thumbnail" style="width: 100px; height: 100px;">
                    </div>
                `,
                didOpen: () => {
                    const fileInput = document.getElementById("imageUpload");
                    fileInput.addEventListener("change", (event) => {
                        const file = event.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                document.getElementById("previewImage").src = e.target.result;
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                },
                preConfirm: () => {
                    const newName = document.getElementById("name").value.trim();
                    const newCategory = document.getElementById("category").value.trim();
                    const newImageUrl = document.getElementById("imageUrl").value.trim(); // URL ‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å input
                    const imageFile = document.getElementById("imageUpload").files[0];

                    return { newName, newCategory, newImageUrl, imageFile };
                }
            });

            if (formValues) {
                let { newName, newCategory, newImageUrl, imageFile } = formValues;
                const updateData = {};

                if (newName && newName !== name) updateData.name = newName;
                if (newCategory && newCategory !== category) updateData.category = newCategory;
                if (newImageUrl && newImageUrl !== imageUrl) updateData.imageUrl = newImageUrl;

                console.log("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ:", updateData);

                if (imageFile) {
                    const imageRef = ref(storage, `Products/${Date.now()}_${imageFile.name}`);
                    await uploadBytes(imageRef, imageFile);
                    const uploadedImageUrl = await getDownloadURL(imageRef);
                    if (uploadedImageUrl !== imageUrl) {
                        updateData.imageUrl = uploadedImageUrl;
                    }
                }

                console.log("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ:", updateData);

                if (Object.keys(updateData).length > 0) {
                    await updateDoc(doc(db, "FoodMenu", id), updateData);
                    Swal.fire('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                } else {
                    Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•!', '', 'info');
                }

                loadData();
            }
        };


        window.importExcel = function () {
            const file = document.getElementById("excelFile").files[0];
            if (!file) {
                Swal.fire({
                    icon: "warning",
                    title: "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel!",
                    text: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤",
                });
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: "array" });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet);

                if (rows.length === 0) {
                    Swal.fire({
                        icon: "error",
                        title: "üìÇ ‡πÑ‡∏ü‡∏•‡πå‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤!",
                        text: "‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á",
                    });
                    return;
                }

                let successCount = 0;
                for (const row of rows) {
                    const name = row.name ? row.name.trim() : "";
                    const category = row.category ? row.category.trim() : "";
                    const imageUrl = row.imageUrl ? row.imageUrl.trim() : "";
                    const ingredients = row.ingredients ? row.ingredients.split(",").map(item => item.trim()) : [];

                    if (name && category && imageUrl) { // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á
                        await addDoc(collection(db, "FoodMenu"), { name, category, imageUrl, ingredients, rating: "0" });
                        successCount++;
                    }
                }

                // ‡πÅ‡∏™‡∏î‡∏á SweetAlert ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
                Swal.fire({
                    icon: "success",
                    title: "‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!",
                    text: `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`,
                });

                loadData();
            };

            reader.readAsArrayBuffer(file);
        };

    </script>


</body>

</html>